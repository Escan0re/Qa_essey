# Тест-план онлайн-заказа пиццы с регистрацией, промокодами и статусами заказа
**Версия:** 1.0  
**Дата:** 24.10.2025  
**Система:** Веб/мобайл фронтенд + REST/GraphQL бэкенд, пуш/WebSocket/Long Poll для статусов

---

## 1. Цели и область охвата (Scope)
Обеспечить корректную работу функционала:
1) Регистрация пользователя с валидацией контактных данных.  
2) Применение промокодов при оформлении заказа.  
3) Обновление и отображение статусов заказа: `создан → подтверждён → готовится → передан курьеру → доставлен`, а также ручная отмена `отменён`.

Выходим на выпуск с уверенностью, что бизнес-правила соблюдены, ошибки обрабатываются предсказуемо, а пользователь видит актуальное состояние заказа в реальном времени.

---

## 2. Предположения и открытые вопросы (для согласования)
- Телефон строго в формате `+43XXXXXXXXXX` (ровно 10 цифр после +43). Регулярное выражение: `^\+43\d{10}$`.
- Имя: 2–50 символов; Адрес: 10–100 символов. Под символами понимаем Unicode-графемы (без нормализации).
- Уникальность e-mail проверяется по всей базе (регистр игнорируется).
- Промокоды (TBD): 
  - по умолчанию **1 промокод на заказ**; нечувствительны к регистру; действуют на сумму корзины **без доставки**; не могут уменьшать сумму ниже 0;
  - существуют типы: фиксированная скидка, процент, мин. сумма заказа, ограничение по времени, ограничение по сегменту (новый пользователь), ограничение по числу применений.
  - поведение при сочетании с другими акциями: по умолчанию **не суммируется** (если не указано иное).
- Канал обновления статусов: WebSocket (первично) с фолбэком на длинный опрос/пуш-уведомления.
- Авторизация: только владелец видит/меняет свой заказ; сервисные роли могут менять статусы.

> Если бизнес-правило отличается — скорректируем соответствующие тесты (см. таблицы решений и State Model).

---

## 3. Стратегия тестирования (кратко)
### 3.1 Уровни и типы тестов
- **Unit (BE/FE):** валидации полей, расчёт скидки, авторизация/права, редьюсеры/сторы, маппинги статусов.
- **Contract/API tests (BE):** схемы запросов/ответов, коды ошибок, идемпотентность, race conditions при смене статусов/отмене.
- **Component tests (FE):** формы (маски, сообщения ошибок), виджеты статусов, отображение скидки/итога.
- **Integration (BE↔FE):** применение промокода к корзине, обновление статусов в UI при событиях из бэкенда.
- **E2E (UI):** сквозные сценарии регистрации → заказ → промокод → отслеживание → доставка/отмена.
- **Non-functional:** производительность (нагрузка на обновления статусов), безопасность (IDOR, rate limiting), UX (локализация, доступность).

### 3.2 Что тестируем на фронтенде и почему
- **FE:** клиентские проверки форм (маски ввода, мгновенные ошибки), корректное отображение текстов/локализации, визуальные состояния кнопок, применение промокода в UI (перерасчёт суммы), реальные обновления статуса (рендер и порядок), доступность (ARIA), отзывчивость.
  - *Обоснование:* снижает задержки обратной связи и предотвращает очевидные ошибки до запроса на сервер; критично для UX.

### 3.3 Что тестируем на бэкенде и почему
- **BE:** серверная валидация и источники истины — формат телефона, длины, уникальность e‑mail, бизнес-правила промо (включая злоупотребления), переходы статусов и транзакционность, аудит/логирование, разграничение доступа.
  - *Обоснование:* доверять только серверу; защита от обхода FE; целостность данных и безопасность.

---

## 4. Техники тест-дизайна и обоснование
- **Классы эквивалентности (EP):** валидные/невалидные форматы телефона, e-mail, диапазоны длин имени/адреса, типы промокодов.
- **Граничные значения (BVA):** имя (1,2,50,51), адрес (9,10,100,101), суммы заказа около порогов (напр. 19.99/20.00 при MIN20).
- **Таблицы решений (Decision Tables):** применимость промокода при разных условиях (тип, дата, сегмент, минимальная сумма, уже применён другой купон).
- **Тестирование переходов состояний (State Transition):** корректные/запрещённые переходы статусов, повторные события, отмена.
- **Pairwise/Combinatorial:** кросс-браузер × тип устройства × тип промокода × способ обновления статуса.
- **Ошибка по наитию (Error Guessing):** повторное применение купона, гонки при отмене, потеря соединения во время обновления статуса.

---

## 5. Требования → Покрытие тестами (матрица трассируемости)
| ID | Требование | Техники | Тесты |
|---|---|---|---|
| R1 | Телефон `+43XXXXXXXXXX` | EP, BVA | REG-01..REG-06 |
| R2 | Имя 2–50 | BVA | REG-07..REG-10 |
| R3 | Адрес 10–100 | BVA | REG-11..REG-14 |
| R4 | Уникальность e‑mail | EP | REG-15..REG-17 |
| R5 | Сообщения об ошибках | EP | REG-18..REG-21 |
| R6 | Применение промокодов | Decision, BVA | PROMO-01..PROMO-14 |
| R7 | Обновление статусов | State | STAT-01..STAT-12 |
| R8 | Ручная отмена → `отменён` | State | STAT-13..STAT-17 |
| R9 | Отображение статусов в UI | Component/E2E | UI-STAT-01..UI-STAT-06 |

---

## 6. Тестовые сценарии (выдержка основных)

### 6.1 Регистрация — позитивные и негативные
**Предусловия:** система доступна, база пуста (кроме случаев с дубликатами).

| ID | Предусловия | Шаги | Ожидаемый результат |
|---|---|---|---|
| REG-01 | — | Ввести телефон `+431234567890`, валидное имя (например, `Ivan`), валидный адрес (≥10 симв.), уникальный e‑mail; отправить | Профиль создан; 201/200; письмо подтверждения (если предусмотрено) |
| REG-02 | — | Телефон без `+` или с буквами | Ошибка валидации поля телефона на FE и BE; подсказка с форматом |
| REG-03 | — | Телефон `+43123456789` (9 цифр) | Ошибка: «Телефон должен быть в формате +43XXXXXXXXXX» |
| REG-04 | — | Телефон `+4312345678901` (11 цифр) | Аналогично REG-03 |
| REG-07 | — | Имя длиной 1 | Ошибка: «Имя должно содержать от 2 до 50 символов» |
| REG-08 | — | Имя длиной 2 | Проходит |
| REG-09 | — | Имя длиной 50 | Проходит |
| REG-10 | — | Имя длиной 51 | Ошибка длины |
| REG-11 | — | Адрес 9 символов | Ошибка длины |
| REG-12 | — | Адрес 10 символов | Проходит |
| REG-13 | — | Адрес 100 символов | Проходит |
| REG-14 | — | Адрес 101 символ | Ошибка длины |
| REG-15 | В БД уже есть e‑mail X | Зарегистрировать с e‑mail X | 409/422; сообщение «E‑mail уже зарегистрирован» |
| REG-16 | — | E‑mail без домена/«@» | Ошибка формата e‑mail |
| REG-18 | — | Оставить обязательные поля пустыми | Локализованные подсказки под каждым полем |
| REG-19 | — | Ввод валиден, но сервис регистрации недоступен | Сообщение об ошибке «Повторите позже», лог и метрика отказов |
| REG-21 | — | Повторная отправка формы (двойной клик) | Защита от дублей, одна учётка, идемпотентность |

**Покрытие FE:** маска номера, мгновенные подсказки, блокировка кнопки при невалидности, aria-invalid, i18n.  
**Покрытие BE:** строгая валидация, нормализация e‑mail, уникальный индекс, коды ошибок, логирование.

---

### 6.2 Промокоды — таблица решений (фрагмент)
**Условия:**  
A — тип купона (PCT/FIX), B — минимальная сумма (Y/N), C — не просрочен (Y/N), D — сегмент подходит (Y/N), E — уже применён другой купон (Y/N), F — кол-во применений не исчерпано (Y/N).  
**Действие:** Применить скидку (Apply / Reject).

| A | B(min ok?) | C | D | E | F | Ожидаемо |
|---|---|---|---|---|---|---|
| PCT | Y | Y | Y | N | Y | Apply |
| FIX | N | Y | Y | N | Y | Reject (не выполнен минимум) |
| PCT | Y | N | Y | N | Y | Reject (истёк) |
| FIX | Y | Y | N | N | Y | Reject (не тот сегмент) |
| PCT | Y | Y | Y | Y | Y | Reject (купон уже применён — правило «1 на заказ») |
| FIX | Y | Y | Y | N | N | Reject (лимит исчерпан) |

**Ключевые сценарии:**
| ID | Предусловия | Шаги | Ожидаемый результат |
|---|---|---|---|
| PROMO-01 | Корзина 25.00 | Ввести `MIN20` | −5.00 (напр., FIX5) или «валидно», итог 20.00 |
| PROMO-02 | Корзина 19.99 | `MIN20` | Отказ и понятное сообщение о минимуме |
| PROMO-03 | — | `SAVE10PCT` (10%) | Итог = subtotal * 0.9; округление по правилам (TBD) |
| PROMO-04 | Купон просрочен | Ввести код | Отказ «Срок действия истёк» |
| PROMO-05 | Пользователь «новый» | `NEWUSER` | Применён |
| PROMO-06 | Пользователь «возвратный» | `NEWUSER` | Отказ «Купон доступен только новым пользователям» |
| PROMO-07 | Уже применён один купон | Ввести второй | Отказ/замена по политике (по умолчанию — отказ) |
| PROMO-08 | Регистр разный | `save10pct` | Применяется (case-insensitive) |
| PROMO-09 | Пустой/пробельный код | ` ` | Подсветка ошибки ввода |
| PROMO-10 | Плохая сеть | Применить купон | Идёмпотентность; отсутствие двойного списания/двойной скидки |
| PROMO-11 | Несовместимость с акцией меню | Применить | Отказ с причиной |
| PROMO-12 | Большой фикс — итог < 0 | `FIX1000` | Итог не ниже 0, скидка ограничена суммой |
| PROMO-13 | Параллельные клики «Применить» | Спам кликов | Одна скидка, блокировка повторов |
| PROMO-14 | API вернул 500 | Применить | Нейтральное сообщение, возможность повторить |

**FE:** корректный пересчёт итога и визуальная метка активного купона.  
**BE:** атомарность применения, лимиты, журналирование, защита от брутфорса купонов (rate limit).

---

### 6.3 Статусы заказа — модель состояний и сценарии
**Допустимые переходы:**  
`создан → подтверждён → готовится → передан курьеру → доставлен`  
`создан|подтверждён|готовится|передан курьеру → отменён` (по правилам, напр. до «доставлен»).

**Недопустимые:** обратные переходы, пропуски стадий (кроме ретраев того же статуса — идемпотентно).

| ID | Предусловия | Шаги | Ожидаемый результат |
|---|---|---|---|
| STAT-01 | Заказ создан | Сервис подтверждает | Статус: подтверждён; событие на FE |
| STAT-02 | Подтверждён | Кухня начинает готовить | Статус: готовится; время начала зафиксировано |
| STAT-03 | Готовится | Передан курьеру | Статус: передан курьеру; данные курьера доступны (если предусмотрено) |
| STAT-04 | Передан курьеру | Доставлен | Статус: доставлен; заказ закрыт |
| STAT-05 | Любой из допустимых | Повторно получить то же событие | Идемпотентно, без дублей в истории |
| STAT-06 | Подтверждён | Попытка поставить «доставлен» напрямую | Отказ 409/422; статус неизменен |
| STAT-07 | Доставлен | Попытка изменить на любой другой | Отказ; финальное состояние |
| STAT-08 | Потеря WS-соединения | Переход «готовится→передан» | FE догоняет через ресинк/поллинг |
| STAT-09 | Параллельно отмена пользователем и «передан курьеру» | Отправить оба события | Разрешение гонки по правилу (TBD): либо отмена блокируется после «передан», либо приоритет у отмены до передачи |
| STAT-10 | Заказ чужого пользователя | Запрос статуса/изменение | 403/404; отсутствие утечки данных |
| STAT-11 | Длинные задержки | Между событиями 5–10 мин | UI показывает «обновлено N мин назад» (если предусмотрено) |
| STAT-12 | Локализация | Все статусы | Строки RU корректные и последовательные |

**Отмена пользователем:**
| ID | Предусловия | Шаги | Ожидаемый результат |
|---|---|---|---|
| STAT-13 | Статус «создан» | Нажать «Отменить заказ» | Статус: отменён; возврат средств по правилам |
| STAT-14 | «подтверждён» | Отменить | В зависимости от политики: разрешено/нельзя; корректное сообщение |
| STAT-15 | «передан курьеру» | Отменить | Обычно запрещено; корректная ошибка |
| STAT-16 | Повторная отмена | Жать ещё раз | Идемпотентность; без дублей |
| STAT-17 | Сеть упала | Отменить → восстановить | Состояния согласованы после ресинка |

**FE:** корректный таймлайн, конфетти/тикеты успеха (если есть), устойчивость к разрыву соединения.  
**BE:** чёткая state machine, транзакции, очередь событий, ретраи с дедупликацией.

---

## 7. E2E-сценарии (Gherkin-стиль, кратко)

### E2E-01: Регистрация → Заказ → Промокод → Доставка
**Given** новый пользователь, корзина на 30.00  
**When** он регистрируется с валидными данными (`+43…`, имя=2–50, адрес=10–100, уникальный e‑mail)  
**And** применяет промокод `SAVE10PCT`  
**And** оформляет заказ  
**Then** видит скидку 10%, статус `создан`  
**And** по мере обработки видит `подтверждён → готовится → передан курьеру → доставлен` без пропусков.

### E2E-02: Дубликат e‑mail и неверный телефон
**Given** существует учётка с e‑mail X  
**When** пользователь регистрируется с e‑mail X и телефоном `+431234`  
**Then** получает два сообщения: «E‑mail уже зарегистрирован», «Телефон в формате +43XXXXXXXXXX».

### E2E-03: Отмена до передачи курьеру
**Given** заказ «подтверждён»  
**When** пользователь нажимает «Отменить»  
**Then** статус `отменён`, средства возвращены согласно политике, уведомление отправлено.

---

## 8. Примеры API-контрактов (BE)
> Примерные схемы — уточнить с backend.

**POST /api/register**
```json
{
  "phone": "+431234567890",
  "name": "Ivan",
  "address": "Vienna, Mariahilfer Str. 10",
  "email": "ivan@example.com"
}
```
**422/409 пример ответа (валидация/дубликат):**
```json
{
  "errors": [
    {"field": "phone", "code": "invalid_format", "message": "Телефон должен быть в формате +43XXXXXXXXXX"}
  ]
}
```

**POST /api/promo/apply**
```json
{
  "orderId": "ord_123",
  "code": "SAVE10PCT"
}
```
**200:**
```json
{
  "discount": {"type":"percent","value":10,"amountApplied":3.00},
  "subtotal": 27.00,
  "total": 27.00
}
```

**PATCH /api/orders/{id}/status**
```json
{ "status": "confirmed" }
```
**409 (недопустимый переход):**
```json
{
  "error": "invalid_transition",
  "from": "created",
  "to": "delivered"
}
```

---

## 9. Нефункциональные проверки
- **Нагрузка:** 1000 одновременных заказов; обновления статусов ≤2 с P95; WS-рекамни/поллинг под деградацией.
- **Безопасность:** IDOR на /orders, rate limiting на /promo/apply и /register, защита от подбора купонов, шифрование PII, логи без утечек данных.
- **Доступность (a11y):** метки для полей, aria-live для обновлений статуса, контраст сообщений об ошибках.
- **Локализация:** все строки RU, падежи, числовые форматы, валюты.

---

## 10. Тестовые данные (примерный набор)
- Телефоны валидные: `+431234567890`, `+439876543210`  
- Телефоны невалидные: `+43ABC…`, `+43123456789`, `+4312345678901`, `431234567890`
- Имя: `I` (1), `Jo` (2), `X…(50)`, `Y…(51)`  
- Адрес: 9/10/100/101 символ  
- E‑mail: `unique@example.com`, `DUP@example.com` (в БД), `bad@`, `bad@dom`  
- Промо: `SAVE10PCT`, `FIX5`, `MIN20`, `NEWUSER`, `EXPIRED2020`, `LIMITED10`.

---

## 11. Критерии приёмки
- Все обязательные требования (R1–R9) покрыты тестами и пройдены.
- Ошибки уровня «блокер/критикал» отсутствуют.
- Идемпотентность статусов и отмен подтверждена.
- Серверные валидации строже/равны клиентским.

---

## 12. Разделение ответственности и артефактов
- **FE артефакты:** unit (Jest/Vitest), component (RTL), E2E (Playwright/Cypress), отчёты о доступности, локализации.
- **BE артефакты:** unit/contract (JUnit/pytest + Pact), интеграционные (Testcontainers), миграции БД (уникальность e‑mail), репорты нагрузки.

---

## 13. Риски и меры
- **Гонки статусов/отмен:** транзакции, очереди, идемпотентные ключи.  
- **Непредусмотренные скидки:** централизованный движок промо, бизнес-правила в одном месте, фича-флаги.  
- **Локализация ошибок:** единственный словарь сообщений, ключи на BE с кодами для FE.

---

## 14. Дефиниции «готово» (DoD)
- Тесты: Unit ≥80%, критичный happy-path покрыт E2E, контрактные тесты зелёные.  
- Документация API актуальна; таблицы решений и State Model отражают прод-правила.  
- Ошибки валидируются одинаково на FE/BE; доступность проверена.

---

> **Примечание:** При изменении бизнес-правил промо/отмены обновить таблицу решений (раздел 6.2) и переходы состояний (6.3).
